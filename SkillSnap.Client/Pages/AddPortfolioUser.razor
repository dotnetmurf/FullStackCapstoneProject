@page "/add-portfoliouser"
@using SkillSnap.Shared.Models
@using SkillSnap.Client.Services
@using SkillSnap.Client.Components
@using Blazored.LocalStorage
@inject PortfolioUserService PortfolioUserService
@inject NavigationManager Navigation
@inject ILocalStorageService LocalStorage

<PageTitle>Add Portfolio User - SkillSnap</PageTitle>

<LoadingSpinner IsLoading="@isSubmitting" Message="Adding portfolio user..." />

<div class="container mt-4" style="@(isSubmitting ? "opacity: 0.6; pointer-events: none;" : "")">
    <h2>Add Portfolio User</h2>

    <EditForm Model="@newUser" OnValidSubmit="@HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />

        <div class="form-group mb-3">
            <label for="name" class="form-label">
                Name:
                <i class="bi bi-info-circle ms-1" 
                   data-bs-toggle="tooltip" 
                   data-bs-placement="right" 
                   title="Required field. Enter your full name (3-100 characters)"></i>
            </label>
            <InputText id="name" class="form-control" @bind-Value="newUser.Name" @bind-Value:after="SaveDraft" placeholder="Enter full name" />
            <ValidationMessage For="@(() => newUser.Name)" />
        </div>

        <div class="form-group mb-3">
            <label for="bio" class="form-label">Bio:</label>
            <InputTextArea id="bio" class="form-control" rows="4" @bind-Value="newUser.Bio" @bind-Value:after="SaveDraft" placeholder="Tell us about yourself..." />
            <ValidationMessage For="@(() => newUser.Bio)" />
        </div>

        <div class="form-group mb-3">
            <label for="imageUrl" class="form-label">
                Profile Image URL:
                <i class="bi bi-info-circle ms-1" 
                   data-bs-toggle="tooltip" 
                   data-bs-placement="right" 
                   title="Enter a direct link to an image (JPG, PNG, or SVG). Example: https://example.com/photo.jpg"></i>
            </label>
            <InputText id="imageUrl" class="form-control" @bind-Value="newUser.ProfileImageUrl" @bind-Value:after="SaveDraft" placeholder="https://example.com/image.jpg" />
            <ValidationMessage For="@(() => newUser.ProfileImageUrl)" />
            <small class="form-text text-muted">Optional: Enter a URL to a profile image</small>
        </div>

        <div class="btn-group-responsive">
            <button type="submit" 
                    class="btn btn-primary" 
                    disabled="@isSubmitting"
                    data-bs-toggle="tooltip" 
                    data-bs-placement="top" 
                    title="Save new portfolio user and navigate to details page">
                <i class="bi bi-check-circle me-1"></i>@(isSubmitting ? "Adding..." : "Add Portfolio User")
            </button>
            <button type="button" 
                    class="btn btn-secondary" 
                    @onclick="async () => await Cancel()" 
                    disabled="@isSubmitting"
                    data-bs-toggle="tooltip" 
                    data-bs-placement="top" 
                    title="Discard changes and return to previous page">
                <i class="bi bi-x-circle me-1"></i>Cancel
            </button>
        </div>
    </EditForm>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-exclamation-circle-fill me-2"></i>
            <strong>Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Success:</strong> @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
    }
</div>

@code {
    private PortfolioUser newUser = new();
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    private const string DraftKey = "add_portfoliouser_draft";

    protected override async Task OnInitializedAsync()
    {
        await RestoreDraft();
    }

    private async Task RestoreDraft()
    {
        try
        {
            var draft = await LocalStorage.GetItemAsync<PortfolioUser>(DraftKey);
            if (draft != null)
            {
                // Restore draft values
                newUser.Name = draft.Name;
                newUser.Bio = draft.Bio;
                newUser.ProfileImageUrl = draft.ProfileImageUrl;
            }
        }
        catch
        {
            // Ignore errors loading draft
        }
    }

    private async Task SaveDraft()
    {
        try
        {
            await LocalStorage.SetItemAsync(DraftKey, newUser);
        }
        catch
        {
            // Ignore errors saving draft
        }
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            var result = await PortfolioUserService.AddPortfolioUserAsync(newUser);
            
            if (result != null)
            {
                successMessage = "Portfolio user added successfully!";
                await LocalStorage.RemoveItemAsync(DraftKey); // Clear draft
                await Task.Delay(1500); // Brief delay to show success message
                Navigation.NavigateTo($"/view-portfoliouser/{result.Id}");
            }
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            errorMessage = "You are not authorized to add a portfolio user. Please log in with an account that has the necessary permissions.";
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Forbidden)
        {
            errorMessage = "You do not have permission to add a portfolio user. This operation requires administrator privileges.";
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Request failed: {ex.Message}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task Cancel()
    {
        await LocalStorage.RemoveItemAsync(DraftKey);
        Navigation.NavigateTo("/portfoliousers");
    }
}
